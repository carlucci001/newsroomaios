rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ============================================
    // HELPER FUNCTIONS
    // ============================================

    function isAuthenticated() {
      return request.auth != null;
    }

    // Simplified admin check - any authenticated user for now
    // TODO: Add proper role-based access in production
    function isAdmin() {
      return isAuthenticated();
    }

    // ============================================
    // ONBOARDING PROGRESS (Temporary session data)
    // ============================================
    match /onboardingProgress/{progressId} {
      allow read, write: if true;
    }

    // ============================================
    // TENANTS (Newspaper Clients)
    // ============================================
    match /tenants/{tenantId} {
      allow read: if true;
      allow write: if true;  // Allow server-side tenant management

      // Tenant subcollections (meta, articles, etc.)
      match /{subcollection}/{docId} {
        allow read: if true;
        allow write: if true;
      }
    }

    // ============================================
    // AI JOURNALISTS
    // ============================================
    match /aiJournalists/{journalistId} {
      allow read: if true;
      allow write: if true;  // Allow server-side journalist management
    }

    // ============================================
    // TENANT CREDITS
    // ============================================
    match /tenantCredits/{creditId} {
      allow read: if true;  // Allow tenant sites to check credits
      allow write: if true;  // Allow server-side credit management
    }

    // ============================================
    // CREDIT USAGE
    // ============================================
    match /creditUsage/{usageId} {
      allow read: if isAuthenticated();
      allow create: if true;  // Allow tenant sites to log usage
      allow update, delete: if isAdmin();
    }

    // ============================================
    // CREDIT TRANSACTIONS
    // ============================================
    match /creditTransactions/{transactionId} {
      allow read: if true;  // Allow credit transaction viewing
      allow write: if true;  // Allow server-side transaction logging
    }

    // ============================================
    // PLATFORM SETTINGS
    // ============================================
    match /settings/{settingId} {
      allow read: if true;  // Allow public read for tenant sites
      allow write: if true;  // Allow seeding (TODO: restrict in production)
    }

    // ============================================
    // ADS / ADVERTISING
    // ============================================
    match /ads/{adId} {
      allow read: if true;  // Allow public read for tenant sites
      allow write: if true;  // Allow seeding
    }

    match /activeAds/{adId} {
      allow read: if true;
      allow write: if true;  // Allow seeding
    }

    // ============================================
    // SITE CONFIG / MODULES
    // ============================================
    match /siteConfig/{configId} {
      allow read: if true;
      allow write: if true;  // Allow seeding (TODO: restrict in production)
    }

    match /modules/{moduleId} {
      allow read: if true;
      allow write: if true;  // Allow seeding
    }

    // ============================================
    // CATEGORIES (for navigation)
    // ============================================
    match /categories/{categoryId} {
      allow read: if true;
      allow write: if true;  // Allow seeding
    }

    // ============================================
    // UPDATE LOGS
    // ============================================
    match /updateLogs/{logId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }

    // ============================================
    // USERS
    // ============================================
    match /users/{userId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && request.auth.uid == userId;
      allow update: if isAuthenticated() &&
        (request.auth.uid == userId || isAdmin());
      allow delete: if isAdmin();
    }

    // ============================================
    // PERSONAS (AI Chat personas for tenant sites)
    // ============================================
    match /personas/{personaId} {
      allow read: if true;  // Allow tenant sites to fetch personas
      allow write: if isAdmin();
    }

    // ============================================
    // ADVERTISERS
    // ============================================
    match /advertisers/{advertiserId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update, delete: if isAdmin();
    }

    // ============================================
    // BUSINESSES (Directory Listings)
    // ============================================
    match /businesses/{businessId} {
      allow read: if true;
      allow create: if isAuthenticated();
      allow update, delete: if isAdmin();
    }

    // ============================================
    // NEWSLETTER SUBSCRIPTIONS
    // ============================================
    match /newsletterSubscriptions/{subscriptionId} {
      allow read: if isAuthenticated();
      allow create: if true;
      allow update, delete: if isAuthenticated();
    }

    // ============================================
    // REVENUE TRANSACTIONS (Server-side only)
    // ============================================
    match /revenueTransactions/{transactionId} {
      allow read: if isAdmin();
      allow write: if false;
    }

    // ============================================
    // LEADS (Territory Reservations - Growth Map)
    // ============================================
    match /leads/{leadId} {
      allow read: if true;  // Public read for growth map
      allow create: if true;  // Allow anyone to reserve a spot
      allow update, delete: if isAdmin();  // Only admins can modify/delete
    }

    // ============================================
    // ACTIVITIES (Growth Map Activity Feed)
    // ============================================
    match /activities/{activityId} {
      allow read: if true;  // Public read for activity feed
      allow create: if true;  // Allow creating activities when leads are created
      allow update, delete: if isAdmin();  // Only admins can modify/delete
    }

    // ============================================
    // MEDIA LIBRARY (Tenant media file metadata)
    // ============================================
    match /media/{mediaId} {
      allow read: if true;
      allow write: if isAuthenticated();
    }

    // ============================================
    // ARTICLES (Root-level for tenant sites)
    // ============================================
    match /articles/{articleId} {
      allow read: if true;
      allow write: if isAuthenticated();
    }

    // ============================================
    // COMMENTS
    // ============================================
    match /comments/{commentId} {
      allow read: if true;
      allow create: if isAuthenticated();
      allow update, delete: if isAuthenticated();
    }

    // ============================================
    // EVENTS (Community calendar)
    // ============================================
    match /events/{eventId} {
      allow read: if true;
      allow write: if isAuthenticated();
    }

    // ============================================
    // BLOG POSTS
    // ============================================
    match /blogPosts/{postId} {
      allow read: if true;
      allow write: if isAuthenticated();
    }

    // ============================================
    // COMMUNITY POSTS
    // ============================================
    match /communityPosts/{postId} {
      allow read: if true;
      allow create: if isAuthenticated();
      allow update, delete: if isAuthenticated();
    }

    // ============================================
    // COMPONENT SETTINGS
    // ============================================
    match /componentSettings/{document=**} {
      allow read: if true;
      allow write: if isAuthenticated();
    }

    // ============================================
    // CONTENT SOURCES & ITEMS
    // ============================================
    match /contentSources/{sourceId} {
      allow read: if true;
      allow write: if isAuthenticated();
    }

    match /contentItems/{itemId} {
      allow read: if true;
      allow write: if isAuthenticated();
    }

    // ============================================
    // SCHEDULED TASKS
    // ============================================
    match /scheduledTasks/{taskId} {
      allow read: if true;
      allow write: if isAuthenticated();
    }

    // ============================================
    // AGENT PROMPTS
    // ============================================
    match /agentPrompts/{promptId} {
      allow read: if true;
      allow write: if isAuthenticated();
    }

    // ============================================
    // NEWSLETTERS
    // ============================================
    match /newsletters/{newsletterId} {
      allow read: if true;
      allow write: if isAuthenticated();
    }

    match /newsletter_subscriptions/{subscriptionId} {
      allow read: if isAuthenticated();
      allow write: if true;
    }

    match /newsletter_templates/{templateId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }

    // ============================================
    // ADVERTISING
    // ============================================
    match /advertising/{adId} {
      allow read: if true;
      allow write: if isAuthenticated();
    }

    match /tenantAds/{adId} {
      allow read: if true;
      allow write: if isAuthenticated();
    }

    // ============================================
    // COMMUNITY (directory, events, etc.)
    // ============================================
    match /community/{document=**} {
      allow read: if true;
      allow write: if isAuthenticated();
    }
  }
}
