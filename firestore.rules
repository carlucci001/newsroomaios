rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ============================================
    // HELPER FUNCTIONS
    // ============================================

    function isAuthenticated() {
      return request.auth != null;
    }

    // Platform admin: verified via custom claim set on Firebase Auth account.
    // This replaces the old isAdmin() = isAuthenticated() which treated
    // every logged-in user as an admin.
    function isPlatformAdmin() {
      return isAuthenticated() && request.auth.token.platformAdmin == true;
    }

    // ============================================
    // ONBOARDING PROGRESS (Temporary session data)
    // Public onboarding flow needs read/write without auth
    // ============================================
    match /onboardingProgress/{progressId} {
      allow read, write: if true;
    }

    // ============================================
    // TENANTS (Newspaper Clients)
    // ============================================
    match /tenants/{tenantId} {
      // Public read: SSR, tenant sites, credit checks all need this
      allow read: if true;

      // Only platform admins can create tenants (via Admin SDK in practice,
      // but rules protect against direct client SDK access)
      allow create: if isPlatformAdmin();

      // Update stays open: credit deduction API uses Client SDK runTransaction
      // on tenant docs without Firebase Auth context. The path itself
      // (tenants/{tenantId}) provides isolation — a tenant can only hit its own doc.
      // Sensitive field changes (apiKey, ownerId, status) use Admin SDK which bypasses rules.
      allow update: if true;

      // Only platform admins can delete tenants
      allow delete: if isPlatformAdmin();

      // Tenant subcollections (meta, articles, categories, users, etc.)
      // Reads are public (SSR needs unauthenticated reads).
      // Writes stay open: server-side API routes (Next.js) use Client SDK
      // without Firebase Auth context. The path provides tenant isolation.
      match /{subcollection}/{docId} {
        allow read: if true;
        allow write: if true;
      }
    }

    // ============================================
    // AI JOURNALISTS
    // Server-only writes (Admin SDK) — lock Client SDK writes
    // ============================================
    match /aiJournalists/{journalistId} {
      allow read: if true;
      allow write: if false;  // All writes via Admin SDK (bypasses rules)
    }

    // ============================================
    // TENANT CREDITS
    // Server-only writes (Admin SDK) — lock Client SDK writes
    // ============================================
    match /tenantCredits/{creditId} {
      allow read: if true;
      allow write: if false;  // All writes via Admin SDK (credits.server.ts)
    }

    // ============================================
    // CREDIT USAGE
    // Server-only writes (Admin SDK)
    // ============================================
    match /creditUsage/{usageId} {
      allow read: if isAuthenticated();
      allow write: if false;  // All writes via Admin SDK
    }

    // ============================================
    // CREDIT TRANSACTIONS
    // Immutable audit log — server-only writes
    // ============================================
    match /creditTransactions/{transactionId} {
      allow read: if true;
      allow create: if false;   // All creates via Admin SDK
      allow update: if false;   // Immutable
      allow delete: if isPlatformAdmin();
    }

    // ============================================
    // PLATFORM SETTINGS
    // ============================================
    match /settings/{settingId} {
      allow read: if true;
      allow write: if isPlatformAdmin();
    }

    // ============================================
    // ADS / ADVERTISING
    // ============================================
    match /ads/{adId} {
      allow read: if true;
      allow write: if isPlatformAdmin();
    }

    match /activeAds/{adId} {
      allow read: if true;
      allow write: if isPlatformAdmin();
    }

    // ============================================
    // SITE CONFIG / MODULES
    // ============================================
    match /siteConfig/{configId} {
      allow read: if true;
      allow write: if isPlatformAdmin();
    }

    match /modules/{moduleId} {
      allow read: if true;
      allow write: if isPlatformAdmin();
    }

    // ============================================
    // CATEGORIES (for navigation)
    // ============================================
    match /categories/{categoryId} {
      allow read: if true;
      allow write: if isPlatformAdmin();
    }

    // ============================================
    // UPDATE LOGS
    // ============================================
    match /updateLogs/{logId} {
      allow read: if isAuthenticated();
      allow write: if isPlatformAdmin();
    }

    // ============================================
    // USERS (Platform admin accounts)
    // ============================================
    match /users/{userId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && request.auth.uid == userId;
      allow update: if isAuthenticated() &&
        (request.auth.uid == userId || isPlatformAdmin());
      allow delete: if isPlatformAdmin();
    }

    // ============================================
    // PERSONAS (AI Chat personas for tenant sites)
    // Server-only writes from tenant sites via Admin SDK
    // ============================================
    match /personas/{personaId} {
      allow read: if true;
      allow write: if isPlatformAdmin();
    }

    // ============================================
    // ADVERTISERS
    // ============================================
    match /advertisers/{advertiserId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update, delete: if isPlatformAdmin();
    }

    // ============================================
    // BUSINESSES (Directory Listings)
    // ============================================
    match /businesses/{businessId} {
      allow read: if true;
      allow create: if isAuthenticated();
      allow update, delete: if isPlatformAdmin();
    }

    // ============================================
    // NEWSLETTER SUBSCRIPTIONS
    // ============================================
    match /newsletterSubscriptions/{subscriptionId} {
      allow read: if isAuthenticated();
      allow create: if true;  // Public subscribe
      allow update, delete: if isAuthenticated();
    }

    // ============================================
    // REVENUE TRANSACTIONS (Server-side only)
    // ============================================
    match /revenueTransactions/{transactionId} {
      allow read: if isPlatformAdmin();
      allow write: if false;  // All writes via Admin SDK
    }

    // ============================================
    // LEADS (Territory Reservations - Growth Map)
    // ============================================
    match /leads/{leadId} {
      allow read: if true;    // Public read for growth map
      allow create: if true;  // Anyone can reserve a spot
      allow update, delete: if isPlatformAdmin();
    }

    // ============================================
    // ACTIVITIES (Growth Map Activity Feed)
    // ============================================
    match /activities/{activityId} {
      allow read: if true;    // Public read for activity feed
      allow create: if true;  // Created alongside leads
      allow update, delete: if isPlatformAdmin();
    }

    // ============================================
    // MEDIA LIBRARY (Platform-level media)
    // ============================================
    match /media/{mediaId} {
      allow read: if true;
      allow write: if isPlatformAdmin();
    }

    // ============================================
    // ARTICLES (Root-level for tenant sites)
    // ============================================
    match /articles/{articleId} {
      allow read: if true;
      allow write: if isAuthenticated();
    }

    // ============================================
    // COMMENTS
    // ============================================
    match /comments/{commentId} {
      allow read: if true;
      allow create: if isAuthenticated();
      allow update, delete: if isAuthenticated();
    }

    // ============================================
    // EVENTS (Community calendar)
    // ============================================
    match /events/{eventId} {
      allow read: if true;
      allow write: if isAuthenticated();
    }

    // ============================================
    // BLOG POSTS
    // ============================================
    match /blogPosts/{postId} {
      allow read: if true;
      allow write: if isAuthenticated();
    }

    // ============================================
    // COMMUNITY POSTS
    // ============================================
    match /communityPosts/{postId} {
      allow read: if true;
      allow create: if isAuthenticated();
      allow update, delete: if isAuthenticated();
    }

    // ============================================
    // COMPONENT SETTINGS
    // ============================================
    match /componentSettings/{document=**} {
      allow read: if true;
      allow write: if isAuthenticated();
    }

    // ============================================
    // CONTENT SOURCES & ITEMS
    // ============================================
    match /contentSources/{sourceId} {
      allow read: if true;
      allow write: if isAuthenticated();
    }

    match /contentItems/{itemId} {
      allow read: if true;
      allow write: if isAuthenticated();
    }

    // ============================================
    // SCHEDULED TASKS
    // ============================================
    match /scheduledTasks/{taskId} {
      allow read: if true;
      allow write: if false;  // All writes via Admin SDK
    }

    // ============================================
    // AGENT PROMPTS
    // ============================================
    match /agentPrompts/{promptId} {
      allow read: if true;
      allow write: if isAuthenticated();
    }

    // ============================================
    // NEWSLETTERS
    // ============================================
    match /newsletters/{newsletterId} {
      allow read: if true;
      allow write: if isAuthenticated();
    }

    match /newsletter_subscriptions/{subscriptionId} {
      allow read: if isAuthenticated();
      allow write: if true;  // Public subscribe/unsubscribe
    }

    match /newsletter_templates/{templateId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }

    // ============================================
    // ADVERTISING (Tenant-level)
    // ============================================
    match /advertising/{adId} {
      allow read: if true;
      allow write: if isAuthenticated();
    }

    match /tenantAds/{adId} {
      allow read: if true;
      allow write: if isAuthenticated();
    }

    // ============================================
    // COMMUNITY (directory, events, etc.)
    // ============================================
    match /community/{document=**} {
      allow read: if true;
      allow write: if isAuthenticated();
    }

    // ============================================
    // PLATFORM CONFIG (Support autopilot, etc.)
    // ============================================
    match /platformConfig/{configId} {
      allow read: if true;
      allow write: if isPlatformAdmin();
    }

    // ============================================
    // PLATFORM RELEASES
    // ============================================
    match /platformReleases/{releaseId} {
      allow read: if true;
      allow write: if isPlatformAdmin();
    }

    // ============================================
    // SUPPORT TICKETS
    // ============================================
    match /supportTickets/{ticketId} {
      allow read: if true;
      allow write: if isAuthenticated();

      match /messages/{messageId} {
        allow read: if true;
        allow write: if isAuthenticated();
      }
    }
  }
}
